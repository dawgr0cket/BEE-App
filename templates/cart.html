{% extends "base.html" %}
{% block title %}B.E.E - Cart{% endblock %}

{% block content %}
<h1 class="display-4">Cart</h1>
{% if 'username' in session %}
<p>{{session['username']}}'s Cart</p>
{% else %}
<p>Guest's Cart</p>
{% endif %}
<script>
let data = 1;

//printing default value of data that is 0 in h2 tag
document.getElementById("counting").innerText = data;

//creation of increment function
function increment() {
    data = data + 1;
    document.getElementById("counting").innerText = data;

}
//creation of decrement function
function decrement() {

    data = data - 1;
    document.getElementById("counting").innerText = data;

}

  document.getElementById('applyDiscountBtn').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent the default form submission behavior

    // Get the discount code value from the input field
    var discountCode = document.getElementById('discount').value;

    // Get the username from the session variable (assuming it's available on the server-side)
    var username = "{{ session['username'] }}";

    // Construct the URL with the discount code and username
    var url = '/applydisc/' + username + '/' + encodeURIComponent(discountCode);

    // Send an AJAX request to apply the discount code
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === XMLHttpRequest.DONE) {
        if (xhr.status === 200) {
          // Discount applied successfully
          alert('Discount applied successfully!');
          // Update the total or perform other necessary actions
        } else {
          // Error applying the discount
          alert('Error applying the discount. Please try again.');
        }
      }
    };
    xhr.send();
  });
</script>
<style>
.form-container {
    max-width: 400px;
    margin: 20px auto;
}

table {
    border-collapse: collapse;
    width: 100%;
}

th,
td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

  th {
    background-color: #f2f2f2;
  }

  .product-image {
    width: 100px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .form-group input[type="text"],
  .form-group input[type="number"] {
    width: 100%;
    padding: 8px;
    font-size: 16px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  .form-group .discount-code {
    display: flex;
    align-items: center;
  }

  .form-group .discount-code input[type="text"] {
    flex-grow: 1;
    padding: 8px;
    font-size: 16px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  .form-group .discount-code button {
    padding: 8px 15px;
    font-size: 16px;
    border: none;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }

  .checkout-button {
    display: block;
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    border-radius: 4px;
    text-decoration: none;
  }

  .total-section {
    margin-top: 20px;
    padding: 10px;
    background-color: #f2f2f2;
  }

  .total-section h3 {
    margin: 0;
    font-weight: bold;
  }

  .shipping-section {
    margin-top: 20px;
  }
</style>
<table>
{% for row in rows %}
    <thead>
        <th>Product</th>
        <th>Price</th>
        <th>Quantity</th>
    </thead>
    {% for l in row %}
    <tr>
        <td>
            <p>{{ row[loop.index - 1]['product_name'] }}</p>
            <object><img src="/static/img/{{ row[loop.index - 1]['product_image'] }}" width="100px"></object>
        </td>
        <td>
            <p>{{ row[loop.index - 1]['product_price'] }}</p>
        </td>
        <td>
            <button onclick="increment()">+</button><h2 id="counting">1</h2><button onclick="decrement()">-</button>
        </td>
        <td>
            <a href="/delete_cart/{{ l['product_name'] }}/{{ session['username'] }}"><img src="/static/img/img_4.png" width="30px"></a>
        </td>
    </tr>
    {% endfor %}
{% endfor %}
</table>
<div class="form-container">
  <form action="/checkout/{{ lists }}/{{ session['username'] }}" method="post">

    <!-- Existing form fields -->

    <!-- Discount Code -->
    <div class="form-group">
      <label for="discount">Discount Code</label>
      <input type="text" id="discount" name="discount">
      <button type="submit" id="applyDiscountBtn">Apply Discount</button>
    </div>

    <!-- Shipping Information -->
    <div class="form-group shipping-section">
      <h3>Shipping Information</h3>
      <label for="address">Address</label>
      <input type="text" id="address" name="address" required>
      <label for="city">City</label>
      <input type="text" id="city" name="city" required>
      <label for="zipcode">Zip Code</label>
      <input type="text" id="zipcode" name="zipcode" required>
    </div>

    <button type="submit" class="checkout-button">Proceed to Checkout</button>
  </form>

  <!-- Total Section -->
  <div class="total-section">
    <h3>Total</h3>
    <p>Subtotal: ${{ total }}</p>
    <p>Discount: -$10</p>
    <p>Shipping: $5</p>
    <p>Grand Total: $95</p>
  </div>
</div>

{% endblock %}